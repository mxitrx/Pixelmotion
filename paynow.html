<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô | Pixelmotion</title>
  <link rel="stylesheet" href="styles/main.css">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="payment-container container">
    <h1>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå)</h1>
    <div class="qr-box">
      <div id="amountText" style="font-size:1.4rem;color:var(--primary-color);margin-top:6px;"></div>
      <img id="qrImage" src="" alt="PromptPay QR">
    </div>

    <form id="payForm" novalidate>
      <div class="form-group">
        <label for="slip">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô (‡∏™‡∏•‡∏¥‡∏õ)</label>
        <input type="file" id="slip" name="slip" accept="image/*" required>
      </div>
      <button type="submit" id="confirmBtn" class="confirm-btn">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
      <div id="result" style="margin-top:10px;"></div>
    </form>
  </div>

  <div class="navbar">
    <a href="index.html">üè†<span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span></a>
    <a href="track.html" class="active">üìã<span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></a>
    <a href="cart.html">üõí<span id="cart-count">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (0)</span></a>
    <a href="profile.html">üë§<span>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤</span></a>
  </div>

  <script src="scripts/cart.js"></script>
  <script>
    const SCRIPT_URL = "YOUR_NEW_GOOGLE_APPS_SCRIPT_URL"; // ‚óÄÔ∏è‚óÄÔ∏è ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà
    const PROMPTPAY_NUMBER = "0972653945"; // ‚óÄÔ∏è‚óÄÔ∏è ‡πÉ‡∏™‡πà‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

    document.addEventListener('DOMContentLoaded', () => {
      const finalOrder = JSON.parse(sessionStorage.getItem('finalOrder'));
      if (!finalOrder) {
        window.location.href = 'cart.html';
        return;
      }

      const totalAmount = finalOrder.totalAmount;
      document.getElementById('amountText').textContent = `‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞: ${totalAmount.toLocaleString('th-TH', { minimumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó`;
      document.getElementById('qrImage').src = `https://promptpay.io/${PROMPTPAY_NUMBER}/${totalAmount.toFixed(2)}.png`;

      document.getElementById('payForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const slipInput = document.getElementById('slip');
        const confirmBtn = document.getElementById('confirmBtn');
        const resultDiv = document.getElementById('result');

        if (!slipInput.files[0]) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô");
          return;
        }

        confirmBtn.disabled = true;
        confirmBtn.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...";
        resultDiv.textContent = "";

        try {
          // Step 1: Upload Slip
          let slipUrl = "";
          const slipFormData = new FormData();
          slipFormData.append('action', 'uploadSlip');
          slipFormData.append('slip', slipInput.files[0], slipInput.files[0].name);

          const uploadRes = await fetch(SCRIPT_URL, { method: 'POST', body: slipFormData });
          const uploadData = await uploadRes.json();
          if (uploadData.result !== 'success') throw new Error(uploadData.message || '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          slipUrl = uploadData.slipUrl;

          // Step 2: Save Order Data
          const orderData = {
            action: 'saveOrder',
            order: { ...finalOrder, slipUrl: slipUrl }
          };

          const saveRes = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(orderData)
          });
          const saveData = await saveRes.json();
          if (saveData.result !== 'success') throw new Error(saveData.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          
          // Success
          localStorage.removeItem('cart'); // ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
          updateCartCount();
          document.querySelector('.payment-container').innerHTML = `
            <div class="success-box">
              <h2>‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</h2>
              <p>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: <strong>${saveData.transactionId}</strong></p>
              <p>‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏±‡∏ö!</p>
              <a href="track.html" class="confirm-btn">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</a>
            </div>
          `;

        } catch (err) {
          resultDiv.textContent = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`;
          confirmBtn.disabled = false;
          confirmBtn.textContent = "‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô";
        }
      });
    });
  </script>
</body>
</html>