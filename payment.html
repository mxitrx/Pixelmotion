<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤ | Pixelmotion</title>
  <link rel="stylesheet" href="styles/main.css">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="payment-container container">
    <div id="confirmation-section">
      <h1>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤</h1>
      
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
        <input id="fullname" type="text" readonly class="readonly-input">
      </div>
      <div class="form-group">
        <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
        <input id="phone" type="tel" readonly class="readonly-input">
      </div>
      
      <div class="summary-box">
        <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤</h3>
        <div id="item-summary-list"></div>
        <div id="summary" class="summary-total">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: 0.00 ‡∏ö‡∏≤‡∏ó</div>
      </div>

      <p class="confirmation-note">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á<br>‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</p>

      <button id="confirmBtn" class="confirm-btn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤</button>
      <div id="result" class="result-message"></div>
    </div>
  </div>

  <div class="navbar">
    <a href="index.html">üè†<span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span></a>
    <a href="track.html">üìã<span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></a>
    <a href="cart.html" class="active">üõí<span id="cart-count">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (0)</span></a>
    <a href="profile.html">üë§<span>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤</span></a>
  </div>

  <script src="scripts/cart.js"></script>
  <script>
    // üî¥ ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡∏ó‡∏µ‡πà Deploy ‡πÅ‡∏•‡πâ‡∏ß
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxF23uipeV9nWOdo6MDkS3bBuycrJnr_23kUi56l1vWSWxYSz3vBTAaqwHIiRHCiRSC/exec";

    document.addEventListener('DOMContentLoaded', () => {
      const checkoutCart = JSON.parse(sessionStorage.getItem('checkoutCart')) || [];
      const customerData = JSON.parse(sessionStorage.getItem('customerData'));

      if (checkoutCart.length === 0 || !customerData) {
        window.location.href = 'cart.html';
        return;
      }

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
      document.getElementById('fullname').value = customerData.fullname;
      document.getElementById('phone').value = customerData.phone;

      // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
      const totalAmount = checkoutCart.reduce((sum, item) => sum + item.totalPrice, 0);
      document.getElementById('summary').textContent = `‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${totalAmount.toLocaleString('th-TH', { minimumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó`;
      
      const itemListDiv = document.getElementById('item-summary-list');
      itemListDiv.innerHTML = checkoutCart.map(item => `
        <div class="summary-item">- ${item.name} (${item.rentDays} ‡∏ß‡∏±‡∏ô)</div>
      `).join('');

      const confirmBtn = document.getElementById('confirmBtn');
      const resultDiv = document.getElementById('result');

      confirmBtn.addEventListener('click', async () => {
        confirmBtn.disabled = true;
        confirmBtn.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
        
        try {
          const orderDetails = {
            customer: customerData,
            items: checkoutCart,
            totalAmount: totalAmount,
            slipUrl: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏•‡∏¥‡∏õ" // ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏•‡∏¥‡∏õ
          };

          const saveData = { action: 'saveOrder', order: orderDetails };

          const res = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(saveData)
          });
          
          const resultData = await res.json();
          if (resultData.result !== 'success') throw new Error(resultData.message);

          // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
          localStorage.removeItem('cart');
          sessionStorage.clear();
          updateCartCount();
          document.querySelector('.payment-container').innerHTML = `
            <div class="success-box">
              <h2>‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h2>
              <p>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á: <strong>${resultData.transactionId}</strong></p>
              <p>‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö</p>
              <a href="track.html" class="confirm-btn">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</a>
            </div>
          `;

        } catch (err) {
          resultDiv.textContent = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`;
          confirmBtn.disabled = false;
          confirmBtn.textContent = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤";
        }
      });
    });
  </script>
</body>
</html>